<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Nanopublication signing demo</title>
    <link rel="icon" href="https://github.com/Nanopublication/nanopub-website/blob/main/static/img/icon.png?raw=true" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="orcid-widget.js"></script>
    <script src="https://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
  </head>

  <body class="bg-gray-800 text-white">
    <div class="flex flex-col h-screen p-4 space-y-4">
      <div class="flex justify-center">
        <h1 class="text-xl font-semibold">Nanopublication signing demo</h1>
      </div>

      <form id="nanopub-form" class="flex flex-col space-y-4 items-center">
        <textarea class="p-2 rounded-sm text-xs text-black w-full" id="rdf-input" rows="30">
@prefix : <http://purl.org/nanopub/temp/mynanopub#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix dc: <http://purl.org/dc/terms/> .
@prefix pav: <http://purl.org/pav/> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix np: <http://www.nanopub.org/nschema#> .
@prefix npx: <http://purl.org/nanopub/x/> .
@prefix ex: <http://example.org/> .

:Head {
  : np:hasAssertion :assertion ;
    np:hasProvenance :provenance ;
    np:hasPublicationInfo :pubinfo ;
    a np:Nanopublication .
}

:assertion {
  ex:mosquito ex:transmits ex:malaria .
}

:provenance {
  :assertion prov:hadPrimarySource <http://dx.doi.org/10.3233/ISU-2010-0613> .
}

:pubinfo {
  : dc:created "2014-07-24T18:05:11+01:00"^^xsd:dateTime ;
    pav:createdBy <http://orcid.org/0000-0002-1267-0234> ;
    a npx:ExampleNanopub .
}
        </textarea>

        <p class="text-center text-sm">
          You will need to provide a
          <a class="text-blue-500 hover:text-blue-700" href="https://raw.githubusercontent.com/vemonet/nanopub-rs/main/lib/tests/resources/id_rsa" target="_blank" rel="noopener noreferrer">
            RSA private key file
          </a>
          that will be used to sign the Nanopub. Save it in your password manager to reuse it easily ðŸ’¡
        </p>

        <div class="text-center bg-slate-600 rounded-md p-2">
          <p class="text-sm">
            If you don't have a private key yet, you can generate one that will be linked to your ORCID.
            By clicking the button below: a RSA private/public key pair will be generated,
            a nanopub will be published linking the public key to your ORCID,
            the private key will be shown to you, so you can store it.
          </p>
          <div id="orcidWidget" class="inline-flex m-2 p-2 rounded-md text-slate-400 bg-slate-700 hover:bg-slate-900 cursor-pointer"></div>
        </div>

        <input type="password" id="private-key" placeholder="Enter Private Key" class="text-black text-center rounded-md"></input>

        <button type="submit" class="p-2 rounded-md text-slate-400 bg-slate-700 hover:bg-slate-600">
          <i class="fas fa-paper-plane"></i> Sign Nanopublication
        </button>

      </form>

      <pre class="mb-4 p-2 text-xs rounded-md bg-gray-700"><code id="rdf-output"></code></pre>
    </div>

    <script type="module">
      import init, { getNpServer, Nanopub, NpProfile } from "https://unpkg.com/@nanopub/sign";

      const orcid="https://orcid.org/0000-0000-0000-0000";

      const rdfInput = document.getElementById('rdf-input');
      const rdfOutput = document.getElementById('rdf-output');
      const form = document.getElementById('nanopub-form');
      let privKey = null;

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const rdfStr = rdfInput.value
        const privKey = document.getElementById('private-key').value
        // WebAssembly binary needs to be initialized. In async functions you can use "await init();"
        init().then(() => {
          console.log("Random Nanopub server:", getNpServer());
          const profile = new NpProfile(orcid, "Your Name", privKey, "");
          try {
            const checked = Nanopub.check(rdfStr);
            console.log("CHECKED", checked.toJs());

            const np = Nanopub.sign(rdfStr, profile)
            rdfOutput.innerText = np.get_rdf();
            console.log("Signed Nanopub:", np.toString());
          } catch (error) {
              rdfOutput.innerText = error.toString();
              console.error("Error:", error);
          }

          // Nanopub.publish(rdfStr, profile, "")
          //   .then(np => {
          //     rdfOutput.innerText = np.get_rdf();
          //     console.log("Published Nanopub:", np.toString());
          //   })
          //   .catch(error => {
          //     rdfOutput.innerText = error;
          //     console.error("Publishing error:", error);
          //   });
        });
      })


      // Setup ORCID login https://github.com/ORCID/orcid-openid-examples/blob/master/js-widget/readme.md
      function onLogin(idToken) {
        idToken.orcid = idToken.iss + '/' + idToken.sub
        idToken.fullName = idToken.given_name + " " + idToken.family_name
        console.log(idToken);
        // Generate private/public key pair
        const keypair = new KeyPair()
        const profile = new NpProfile(idToken.orcid, idToken.fullName, keypair.private, "");
        // Publish nanopub link to public key,
        // const intro = Nanopub.publish_intro(profile, getNpServer(false))
        const intro = Nanopub.publish_intro(profile, "")
          .then(np => {
            rdfOutput.innerText = np.get_rdf();
            console.log("Published Introduction Nanopub:", np.toString());
            // TODO: Display private key
            // document.getElementById("display-privkey").textContent = keypair.private
          })
          .catch(error => {
            rdfOutput.innerText = error;
            console.error("Publishing error:", error);
          });
      }
      function onError() {
        console.error("Error when login.")
      }
      var config = {
        // "mode": "sandbox",
        // "returnUrl": "http://localhost:3000/demo.html",
        "mode": "live",
        "clientId": "APP-TEANCMSUOPYZOGJ3",
        "returnUrl": "https://vemonet.github.io/nanopub-rs/demo.html",
        "onSuccess": onLogin,
        "onFail": onError,
        "auto": true
      };
      document.addEventListener('DOMContentLoaded', function() {
        ORCID.init(config);
      });
    </script>
  </body>
</html>
