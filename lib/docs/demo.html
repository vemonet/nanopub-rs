<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Nanopublication signing demo</title>
    <link rel="icon" href="https://github.com/Nanopublication/nanopub-website/blob/main/static/img/icon.png?raw=true" type="image/x-icon">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Highlight JS -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="assets/turtle.js"></script>
    <!-- ORCID login widget -->
    <script src="assets/orcid-widget.js"></script>
    <script src="https://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
  </head>

  <body class="bg-gray-800 text-white">
    <div class="flex flex-col h-screen items-center p-4 space-y-4">
      <h1 class="text-xl font-semibold">Nanopublication signing demo</h1>
      <p class="text-sm">
        In your browser, using the package
        <a class="text-blue-500 hover:text-blue-700" href="https://vemonet.github.io/nanopub-rs/use_javascript.html" target="_blank" rel="noopener noreferrer">
          <b><code>@nanopub/sign</code></b>
        </a>
      </p>

      <!-- Nanopub RDF input -->
      <textarea class="p-2 rounded-sm text-xs text-black w-full" id="rdf-input" rows="28">
@prefix : <http://purl.org/nanopub/temp/mynanopub#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix dc: <http://purl.org/dc/terms/> .
@prefix pav: <http://purl.org/pav/> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix np: <http://www.nanopub.org/nschema#> .
@prefix npx: <http://purl.org/nanopub/x/> .
@prefix ex: <http://example.org/> .

:Head {
  : np:hasAssertion :assertion ;
    np:hasProvenance :provenance ;
    np:hasPublicationInfo :pubinfo ;
    a np:Nanopublication .
}

:assertion {
  ex:mosquito ex:transmits ex:malaria .
}

:provenance {
  :assertion prov:hadPrimarySource <http://dx.doi.org/10.3233/ISU-2010-0613> .
}

:pubinfo {
  : a npx:ExampleNanopub .
}</textarea>

      <!-- Private key input -->
      <p class="text-center text-sm">
        You will need to provide a
        <a class="text-blue-500 hover:text-blue-700" href="https://raw.github.com/vemonet/nanopub-rs/main/lib/tests/resources/id_rsa" target="_blank" rel="noopener noreferrer">
          RSA private key file
        </a>
        that will be used to sign the Nanopub. Save it in your password manager to reuse it easily ðŸ’¡
      </p>
      <input type="password" id="private-key" placeholder="Enter Private Key" class="text-black text-center rounded-md"></input>

      <!-- Card to login with ORCID, generate and register private keys -->
      <div class="flex flex-col items-center text-sm bg-slate-600 rounded-md p-3 space-y-2">
        <p>
          If you don't have a private key yet, you can generate one that will be linked to your ORCID.
        </p>
        <div class="flex justify-center space-x-2">
          <div id="orcidWidget" class="inline-flex p-2 space-x-2 rounded-md text-slate-400 bg-slate-700 hover:bg-slate-900 cursor-pointer">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/06/ORCID_iD.svg" width="20" height="20" alt="ORCID" />
          </div>
          <button id="publish-intro-btn" class="hidden p-2 rounded-md text-slate-400 bg-slate-700 hover:bg-slate-900">
            <i class="fas fa-key mr-2"></i> Generate key and publish introduction
          </button>
        </div>

        <!-- Display generated private key -->
        <div id="privkey-card" class="hidden flex flex-col items-center space-y-2">
          <p>
            The Nanopublication Introduction has been published successfully ðŸŽ‰
          </p>
          <p>
            You can now <b>copy the private key below</b>, store it somewhere (e.g. your password manager),
            and reuse-it later to sign Nanopublications:
          </p>
          <p id="display-privkey" class="break-all rounded-md bg-green-500 p-2"></p>
        </div>
      </div>

      <!-- Submit nanopub btn -->
      <button id="submit-btn" class="p-2 rounded-md text-slate-400 bg-slate-700 hover:bg-slate-600">
        <i class="fas fa-pen-nib mr-2"></i> Sign Nanopublication
      </button>

      <pre class="w-full">
        <code id="rdf-output" class="language-turtle bg-slate-900 text-xs rounded-md"></code>
      </pre>
    </div>

    <script type="module">
      import init, { getNpServer, Nanopub, NpProfile, KeyPair } from "https://unpkg.com/@nanopub/sign";
      hljs.registerLanguage('turtle', window.hljsDefineTurtle);

      let privKey = null;
      let orcidToken = null;
      let orcid = "";
      const rdfInput = document.getElementById('rdf-input');
      const rdfOutput = document.getElementById('rdf-output');
      // TODO: get ORCID based on the public key registered in the nanopub network

      // Sign nanopub
      document.getElementById('submit-btn').addEventListener('click', (event) => {
        const rdfStr = rdfInput.value
        const privKey = document.getElementById('private-key').value
        // WebAssembly binary needs to be initialized. In async functions you can use "await init();"
        init().then(() => {
          console.log("Random Nanopub server:", getNpServer());
          const profile = new NpProfile(orcid, "Your Name", privKey, "");
          try {
            const checked = Nanopub.check(rdfStr);
            console.log("CHECKED", checked.toJs());

            const np = Nanopub.sign(rdfStr, profile)
            rdfOutput.textContent = np.get_rdf();
            console.log("Signed Nanopub:", np.toString());
            hljs.highlightAll();
          } catch (error) {
            rdfOutput.textContent = error.toString();
            console.error("Error:", error);
          }

          // Nanopub.publish(rdfStr, profile, "")
          //   .then(np => {
          //     rdfOutput.textContent = np.get_rdf();
          //     console.log("Published Nanopub:", np.toString());
          //   })
          //   .catch(error => {
          //     rdfOutput.textContent = error;
          //     console.error("Publishing error:", error);
          //   });
        });
      });

      // Generate key pair and publish Nanopub intro
      const introBtn = document.getElementById('publish-intro-btn')
      introBtn.addEventListener('click', (event) => {
        const keypair = new KeyPair()
        const profile = new NpProfile(orcidToken.orcid, orcidToken.fullName, keypair.private, "");
        // Publish nanopub link to public key
        const intro = Nanopub.publish_intro(profile, getNpServer(false))
          .then(np => {
            rdfOutput.textContent = np.get_rdf();
            console.log("Published Introduction Nanopub:", np.toString());
            // Display private key
            document.getElementById("privkey-card").classList.remove("hidden");
            document.getElementById("display-privkey").textContent = keypair.private
            hljs.highlightAll();
          })
          .catch(error => {
            rdfOutput.textContent = error;
            console.error("Publishing error:", error);
          });
      });

      // Setup ORCID login https://github.com/ORCID/orcid-openid-examples/blob/master/js-widget/readme.md
      function onLogin(idToken) {
        idToken.orcid = idToken.iss + '/' + idToken.sub
        idToken.fullName = idToken.given_name + " " + idToken.family_name
        orcid = idToken.orcid;
        orcidToken = idToken
        introBtn.classList.remove("hidden");
        console.log("Logged in", idToken);
      }
      function onError() {
        console.error("Error when login.")
      }
      var config = {
        // "mode": "sandbox",
        // "returnUrl": "http://localhost:3000/demo.html",
        "mode": "live",
        "clientId": "APP-TEANCMSUOPYZOGJ3",
        "returnUrl": "https://vemonet.github.io/nanopub-rs/demo.html",
        "onSuccess": onLogin,
        "onFail": onError,
        "buttonText": "Authenticate with ORCID",
        "auto": true
      };
      document.addEventListener('DOMContentLoaded', function() {
        ORCID.init(config);
      });

      // For dev:
      // document.addEventListener("DOMContentLoaded", function(e) {
      //   const testPrivate = "MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBAPdEfIdHtZYoFh6/DWorzoHpFXMjugqW+CGpe9uk4BfUq54MToi2u7fgdGGtXLg4wsJFBYETdVeS0p1uA7EPe8LhwjHPktf5c6AZbO/lYpKM59e7/Ih4mvOy4iTIe/Dv+1OgasTSK0nXAbKUm/5iJ6LOYa82JQeE/QnT5gUw2e97AgMBAAECgYBbNQnyJINYpeSy5qoeFZaQ2Ncup2kCavmQASJMvJ5ka+/51nRJfY30n3iOZxIiad19J1SGbhUEfoXtyBzYfOubF2i2GJtdF5VyjdSoU6w/gOo2/vnbH+GCHnMclrWshohOADGQU/Y8pYhIvlQqcb6xEOts9m9C9g4uwvPXqjmhoQJBAPkmSFIZwF3i2UvJlHyeXi599L0jkGTUJy/Y4IjieUx5suwvAtG47ejhgIPKK06VtW49oGPHWjWc3cJAmnV+vTMCQQD+EPTvNtLpX9QiDEJD7b8woDwmVrvH/RUosP/cXpMQd7BUVgPlpffAlFJGDlOzwwjZjy+8kc6MYevh1kWqobSZAkEAyCs+nV99ErEHnYEFoB1oU3f0oeSpxKhCF4np03AIvi1kV6bpX+9wjNJnevp5UriqvDgc3S0zx7EQ5Vkb/1vkywJBAMMw59y4tAVT+DhITsi9aTvEfzG9RPt6trzSb2Aw0K/AJJpGkyvl/JfZ2/Oyoh/jYXM0DKrFIni76mtRIajcH1ECQQCJi6aXOaRkRPmf7FYY9cRaJdR1BtZkKZbDg6ZMD1bY97cGiM9STTMeldYcCtQBtyhVCTEObI/V6/0FAvY9Zi7w"
      //   document.getElementById("privkey-card").classList.remove("hidden");
      //   document.getElementById("display-privkey").textContent = testPrivate
      //   introBtn.classList.remove("hidden");
      // });
    </script>
  </body>
</html>
